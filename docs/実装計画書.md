# 会計Freee MCP 実装計画書

## 概要
本書は、会計Freee MCPシステムの未実装機能を段階的に実装するための計画書です。
高度な機能（連結財務諸表、内部取引消去等）を除く、基本〜中級機能の実装を対象とします。

最終更新日: 2025-09-21

## 実装対象機能一覧

### ✅ 実装済み機能（フェーズ1-7完了）

#### 基本API機能
- 仕訳データ取得 API（/freee/journals）- detail切り替え対応済み
- 勘定科目マスタ取得 API（/freee/account_items）
- 品目マスタ取得 API（/freee/items）
- 部門マスタ取得 API（/freee/sections）
- 税区分マスタ取得 API（/freee/taxes）
- メモタグマスタ取得 API（/freee/tags）
- 取引先マスタ取得 API（/freee/partners）✅実装済み

#### 分析・集計機能
- 月次推移表作成 API（/freee/monthly-trends）
- 増減要因分析 API（/freee/variance-analysis）
- 計上ルート別集計 API（/freee/entry-route-analysis）
- 取引先別年間集計 API（/freee/partner-yearly-summary）

#### 予算管理機能
- 予算データ取込 API（POST /freee/budgets）- SQLite永続化対応済み
- 予算データ取得 API（GET /freee/budgets）
- 予実比較 API（/freee/budget-comparison）

#### 認証・セキュリティ機能（✅実装済み）
- OAuth2.0リフレッシュトークン実装
- AES-256-GCM暗号化によるトークン保存
- 自動トークン更新機能

#### エラーハンドリング・信頼性機能（✅実装済み）
- 指数バックオフによるリトライ機構
- レート制限対応（トークンバケット方式）
- 構造化JSONログ出力
- ログローテーション機能

#### キャッシュ・監査機能（✅実装済み）
- SQLiteベースのキャッシュシステム
- 包括的な監査ログ機能
- データ整合性検証（SHA-256ハッシュ）

#### Excel出力機能（✅実装済み）
- 全エンドポイント対応のExcelエクスポート
- レポートタイプ別の最適化されたシート構造

- 共通スキーマ変換処理（simple/standard/full対応）
- テストカバレッジ: 統合テスト実装済み

### 📋 今後の拡張予定機能
| 機能 | 詳細 | 優先度 | 工数 | 影響 |
|-----|------|--------|------|------|
| 連結財務諸表作成 | 複数会社の財務データ統合 | 低 | 5日 | エンタープライズ機能 |
| 内部取引消去 | グループ内取引の自動消去 | 低 | 3日 | 連結会計対応 |
| AIベース異常検知 | 機械学習による不正検出 | 低 | 7日 | リスク管理強化 |


## 実装詳細

### フェーズ4: 認証基盤強化【最優先】

#### 4.1 OAuth2.0リフレッシュトークン実装
```javascript
// src/services/tokenManager.js を更新
export async function refreshAccessToken(provider) {
  const refreshToken = await getStoredRefreshToken(provider);
  const response = await fetch(`${OAUTH_URL}/token`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type: 'refresh_token',
      refresh_token: refreshToken,
      client_id: process.env.FREEE_CLIENT_ID,
      client_secret: process.env.FREEE_CLIENT_SECRET
    })
  });
  const tokens = await response.json();
  await storeTokens(provider, tokens);
  return tokens.access_token;
}
```
- トークン期限監視
- 自動更新メカニズム
- セキュアなトークン保存

#### 4.2 トークン管理の永続化
```javascript
// src/services/tokenStorage.js を新規作成
import crypto from 'crypto';
import fs from 'fs/promises';

export async function storeTokens(provider, tokens) {
  const encrypted = encrypt(tokens);
  await fs.writeFile(`.tokens/${provider}.json`, encrypted);
}
```

### フェーズ5: エラーハンドリング・信頼性強化

#### 5.1 リトライ機構実装
```javascript
// src/utils/retry.js を新規作成
export async function retryWithBackoff(fn, options = {}) {
  const { maxRetries = 3, initialDelay = 1000 } = options;
  let lastError;
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;
      if (i < maxRetries - 1) {
        const delay = initialDelay * Math.pow(2, i);
        await sleep(delay);
      }
    }
  }
  throw lastError;
}
```

#### 5.2 レート制限対応
```javascript
// src/utils/rateLimit.js を新規作成
export async function handleRateLimit(response) {
  if (response.status === 429) {
    const retryAfter = response.headers.get('Retry-After') || 60;
    await sleep(retryAfter * 1000);
    return true;
  }
  return false;
}
```

#### 5.3 エラーログ記録
```javascript
// src/utils/errorLogger.js を新規作成
import winston from 'winston';

const logger = winston.createLogger({
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

export function logError(error, context) {
  logger.error({
    message: error.message,
    stack: error.stack,
    context,
    timestamp: new Date().toISOString()
  });
}
```

### フェーズ6: APIルーティング・構造改善

#### 6.1 APIルーティング整理
```javascript
// server.js を更新
import freeeRoutes from './src/routes/freee.js';

// 既存の /journals を /freee/journals に移行
app.use('/freee', freeeRoutes);
```

#### 6.2 取引先マスタ実装
```javascript
// src/services/freeeClient.js を更新
export async function getPartners(params = {}) {
  const token = await getAccessToken('freee');
  const query = new URLSearchParams({
    company_id: process.env.FREEE_COMPANY_ID,
    ...params
  }).toString();
  
  const response = await retryWithBackoff(async () => {
    return await fetch(`${FREEE_API_BASE_URL}/api/1/partners?${query}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
  });
  
  if (!response.ok) {
    throw new Error(`freee API error: ${response.status}`);
  }
  
  return response.json();
}
```

### フェーズ7: パフォーマンス・運用改善

#### 7.1 ローカルキャッシュ実装
```javascript
// src/services/cache.js を新規作成
import Database from 'better-sqlite3';

const db = new Database('cache.db');

export async function getCachedData(key, ttl = 3600) {
  const row = db.prepare('SELECT * FROM cache WHERE key = ? AND expires_at > ?')
    .get(key, Date.now());
  return row ? JSON.parse(row.data) : null;
}

export async function setCachedData(key, data, ttl = 3600) {
  db.prepare('INSERT OR REPLACE INTO cache (key, data, expires_at) VALUES (?, ?, ?)')
    .run(key, JSON.stringify(data), Date.now() + ttl * 1000);
}
```

#### 7.2 監査ログ機能
```javascript
// src/middleware/auditLog.js を新規作成
export function auditLog(req, res, next) {
  const start = Date.now();
  res.on('finish', () => {
    logger.info({
      method: req.method,
      url: req.url,
      status: res.statusCode,
      duration: Date.now() - start,
      user: req.user?.email,
      timestamp: new Date().toISOString()
    });
  });
  next();
}
```

## テスト計画

### 単体テスト
- 各APIエンドポイントのテスト
- 集計ロジックのテスト
- エラーハンドリングのテスト

### 結合テスト
- Freee APIとの連携テスト
- エンドツーエンドのデータフロー確認

### 性能テスト
- 大量データ（仕訳10,000件）での応答時間測定
- 同時アクセス時の動作確認

## スケジュール

### 完了済みフェーズ
| フェーズ | 期間 | 開始日 | 終了日 | ステータス |
|---------|------|--------|--------|-----------|
| フェーズ1: マスタデータAPI | 1日 | 2025-09-20 | 2025-09-20 | ✅完了 |
| フェーズ2: 集計機能 | 1日 | 2025-09-20 | 2025-09-20 | ✅完了 |
| フェーズ3: 予実管理 | 1日 | 2025-09-20 | 2025-09-20 | ✅完了 |
| フェーズ4: 認証基盤強化 | 0.5日 | 2025-09-21 | 2025-09-21 | ✅完了 |
| フェーズ5: エラーハンドリング | 0.5日 | 2025-09-21 | 2025-09-21 | ✅完了 |
| フェーズ6: API構造改善 | 0.5日 | 2025-09-21 | 2025-09-21 | ✅完了 |
| フェーズ7: パフォーマンス改善 | 0.5日 | 2025-09-21 | 2025-09-21 | ✅完了 |
| 統合テスト・最終調整 | 0.5日 | 2025-09-21 | 2025-09-21 | ✅完了 |

**合計所要期間**: 2.5営業日で全フェーズ完了
**全体進捗**: 100%完了

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Freee API仕様変更 | 高 | APIバージョン固定、変更通知の監視 |
| レート制限超過 | 中 | バッチ処理の分割、キャッシュ活用 |
| データ量増大による性能劣化 | 中 | ページネーション、インデックス最適化 |

## 成功指標

### 達成済み指標
- ✅ マスタデータAPI全エンドポイント実装完了
- ✅ 集計・分析機能の実装完了
- ✅ テストカバレッジ: 統合テスト実装済み
- ✅ 実API連携テスト: 6項目全て成功
- ✅ OAuth2.0リフレッシュトークン自動更新: 実装完了
- ✅ APIリトライ機能: 全API実装済み
- ✅ レート制限対応: トークンバケット方式実装済み
- ✅ キャッシュ機能: SQLite実装済み
- ✅ 監査ログ: 包括的な記録機能実装済み
- ✅ Excel出力: 全エンドポイント対応済み

### 達成指標
- 全APIエンドポイントの正常動作
- レスポンスタイム: 5秒以内（仕訳1,000件）
- エラー率: 0.1%以下
- OAuth2.0リフレッシュトークン自動更新成功率: 99.9%以上
- APIリトライ成功率: 95%以上

## 実装優先順位の根拠

1. **認証基盤強化（最優先）**: トークン期限切れはサービス全停止に直結
2. **エラーハンドリング（高優先）**: 本番環境での安定稼働に必須
3. **API構造改善（中優先）**: インターフェース仕様準拠で将来の拡張性確保
4. **パフォーマンス改善（中優先）**: 大量データ処理時の効率化

## 備考

- 本計画は基本〜中級機能の実装に焦点を当てています
- 高度な機能（連結財務諸表、内部取引消去等）は将来の拡張として別途計画します
- QuickBooks連携は現時点では対象外とします
- 実装中に発見された課題は随時計画を更新して対応します
- 全フェーズが2025-09-21に完了しました
- freee API実環境での統合テストが成功しました
- 予算データのSQLite永続化が実装されました
- Excel出力機能が全エンドポイントで利用可能です