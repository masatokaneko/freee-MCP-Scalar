# 会計Freee MCP セットアップ手順書

最終更新日: 2025-09-24
実装状況: コアAPIおよびレポート自動生成CLI実装済み

## 1. セットアップ手順（ローカル）

### 1.1 プロジェクト作成

```bash
# プロジェクトクローン
git clone https://github.com/your-org/freee-MCP-Scalar.git
cd freee-MCP-Scalar

# 依存関係インストール
npm install
```

### 1.2 環境変数設定（`.env`）

```env
# Freee API Configuration
FREEE_CLIENT_ID=your_client_id
FREEE_CLIENT_SECRET=your_client_secret
FREEE_REDIRECT_URI=http://127.0.0.1:8080/callback
FREEE_CALLBACK_URL=http://127.0.0.1:8080/callback
FREEE_API_BASE_URL=https://api.freee.co.jp

# Freee Company & Tokens (認証後に設定)
FREEE_COMPANY_ID=1234567
FREEE_ACCESS_TOKEN=xxx
FREEE_REFRESH_TOKEN=yyy
FREEE_TOKEN_EXPIRES_AT=2025-09-22T13:53:08.297Z

# Server Configuration
PORT=3000
NODE_ENV=development

# Token Encryption Key (32 characters)
TOKEN_ENCRYPTION_KEY=your-32-character-encryption-key!!
```

### 1.3 OAuth認証とトークン取得

```bash
# OAuth認証フローを実行
node scripts/get_token.js

# 8080番ポートでコールバック待機 → ブラウザでfreeeログイン
# 認可後、アクセストークン／リフレッシュトークンがターミナル＆ブラウザに表示されるので .env に追記する
```

#### 会社IDの確認

```bash
node scripts/get_company.js
# 出力された ID を .env の FREEE_COMPANY_ID に設定
```

### 1.4 サーバー起動（任意）

```bash
# 本番相当
npm start

# 開発モード（ホットリロード）
npm run dev
```

サーバーが http://localhost:3000 で起動します。API サーバーを起動せずに CLI のみ利用する場合はこのステップは任意です。

### 1.5 動作確認

```bash
curl "http://localhost:3000/freee/account_items?company_id=${FREEE_COMPANY_ID}"
NODE_OPTIONS=--experimental-vm-modules npm test
```

---

## 2. 実装済みAPIエンドポイント（抜粋）

```bash
# 月次推移表
curl "http://localhost:3000/freee/monthly-trends?company_id=${FREEE_COMPANY_ID}&start_date=2025-01-01&end_date=2025-01-31"

# 増減要因分析
curl "http://localhost:3000/freee/variance-analysis?company_id=${FREEE_COMPANY_ID}&current_start=2025-01-01&current_end=2025-01-31&previous_start=2024-12-01&previous_end=2024-12-31"

# 計上ルート別集計
curl "http://localhost:3000/freee/entry-route-analysis?company_id=${FREEE_COMPANY_ID}&start_date=2025-01-01&end_date=2025-01-31"

# 取引先別年間集計
curl "http://localhost:3000/freee/partner-yearly-summary?company_id=${FREEE_COMPANY_ID}&start_date=2025-01-01&end_date=2025-12-31"
```

---

## 3. レポート自動生成

### 3.1 月次PL試算表（新機能）

```bash
# 2025年1月のPL試算表をCSVで出力
node scripts/generate_pl_report.js --month=2025-01 --output-dir=$HOME/freee-reports

# 任意期間をCSV+JSONで出力
node scripts/generate_pl_report.js --start=2025-01-01 --end=2025-03-31 --format=csv,json --output-dir=$HOME/freee-reports

# FREEE_REPORT_OUTPUT_DIR を設定しておけば毎回指定は不要
export FREEE_REPORT_OUTPUT_DIR=$HOME/freee-reports
node scripts/generate_pl_report.js --month=2025-02

# 勘定科目×月のピボット表を追加出力（CSV）
node scripts/generate_pl_report.js --month=2025-03 --pivot

# 取引先・品目の推移表まで一括生成（勘定科目別内訳）
node scripts/generate_pl_report.js --start=2024-12-01 --end=2025-05-31 --group=account,partner,item --pivot

# デフォルト出力先: private_reports/pl_trial_balance[_partner|_item]_YYYYMMDD_YYYYMMDD.csv
# ピボット有効時: private_reports/pl_trial_balance[_partner|_item]_pivot_YYYYMMDD_YYYYMMDD.csv
# 取引先・品目レポートは勘定科目合計と照合し、不整合があればコンソールに警告を出力
# 併せて勘定科目コード対照表（account_code_catalog.csv）も生成されます
```

### 3.2 Excelエクスポート（従来機能）

```bash
# 任意エンドポイントのデータをExcel化
node scripts/export_to_excel.js journals "start_date=2025-01-01&end_date=2025-01-31" output/journals.xlsx
```

### 3.3 OSS公開時の注意

- `private_reports/` は `.gitignore` 済みのため、デフォルト出力物はコミット対象になりません。
- 社外秘データを扱う場合は `--output-dir` / `FREEE_REPORT_OUTPUT_DIR` でリポジトリ外パスを指定することを推奨します。
- 既に追加してしまった場合は `git rm --cached path/to/file` で追跡解除してからコミットしてください。

- `scripts/export_freee_reports.js` を使うと、Google Sheets テンプレートと互換のある各種 CSV（PL/BS/月次推移/仕訳帳など）をまとめて出力できます。
- 勘定科目コード体系の詳細は `docs/勘定科目コード体系.md` を参照してください。

```bash
node scripts/export_freee_reports.js \
  --start=2024-12-01 --end=2025-05-31 \
  --reports=all \
  --output-dir=$HOME/freee-reports
```

生成される主なファイル:
- `pl_account_monthly.csv`, `pl_partner_monthly.csv`, `pl_item_monthly.csv`, `pl_section_monthly.csv`
- `trial_pl_full.csv`, `trial_bs_full.csv`
- `pl_sections_summary.csv`, `pl_items_summary.csv`
- `journals_generic_v2.csv`
- `account_code_catalog.csv`

---

## 4. トラブルシューティング

### 4.1 トークンが無効な場合

```bash
node scripts/get_token.js
# 新しいトークンを .env に貼り付け、アプリ／CLIを再実行
```

### 4.2 レート制限エラー

- 自動リトライとレート制限制御が実装済み。
- 頻発する場合はリクエストの間隔を広げる、もしくは処理を分割する。

### 4.3 ログ確認

```bash
# エラーログ
tail -f logs/error.log

# APIリクエストログ
tail -f logs/combined.log
```

---

## 5. サポート情報
- README.md: プロジェクト概要と基本的な利用方法
- docs/仕様変更履歴.md: リリース履歴
- docs/実装計画書.md: ロードマップと今後のタスク
- docs/データ運用ガイド.md: 公開時のデータ分離運用
