# 会計Freee MCP セットアップ手順書

最終更新日: 2025-09-21
実装状況: 全機能実装完了

## 1. セットアップ手順（ローカル）

### 1.1 プロジェクト作成

```bash
# プロジェクトクローン
git clone https://github.com/your-org/freee-MCP-Scalar.git
cd freee-MCP-Scalar

# 依存関係インストール
npm install
```

### 1.2 環境変数設定（`.env`）

```env
# Freee API Configuration
FREEE_CLIENT_ID=your_client_id
FREEE_CLIENT_SECRET=your_client_secret
FREEE_CALLBACK_URL=http://127.0.0.1:8080/callback
FREEE_API_BASE_URL=https://api.freee.co.jp

# Server Configuration  
PORT=3000
NODE_ENV=development

# Token Encryption Key (32 characters)
TOKEN_ENCRYPTION_KEY=your-32-character-encryption-key!!
```

### 1.3 OAuth認証とトークン取得

#### ステップ1: アクセストークン取得

```bash
# OAuth認証フローを実行
node scripts/get_token.js

# ブラウザが開き、Freeeログイン画面が表示されます
# ログイン後、.envファイルにトークンが自動保存されます
```

#### ステップ2: 会社ID取得

```bash
# アクセス可能な会社一覧を取得
node scripts/get_company.js

# 出力例:
# Company 1:
#   ID: 1356167
#   Name: 株式会社Scalar
#   Role: admin
#
# Add this to your .env file:
# FREEE_COMPANY_ID=1356167
```

.envファイルに`FREEE_COMPANY_ID`を追加してください。

### 1.4 サーバー起動

```bash
# サーバー起動
npm start

# または開発モードで起動（ホットリロード対応）
npm run dev
```

サーバーが http://localhost:3000 で起動します。

### 1.5 動作確認

```bash
# API動作テスト
curl "http://localhost:3000/freee/account_items?company_id=${FREEE_COMPANY_ID}"

# 統合テスト実行
npm test
```

---

## 2. 実装済みAPIエンドポイント

### 2.1 基本マスタデータ

```bash
# 勘定科目マスタ
curl "http://localhost:3000/freee/account_items?company_id=${FREEE_COMPANY_ID}"

# 取引先マスタ
curl "http://localhost:3000/freee/partners?company_id=${FREEE_COMPANY_ID}"

# 品目マスタ
curl "http://localhost:3000/freee/items?company_id=${FREEE_COMPANY_ID}"

# 部門マスタ
curl "http://localhost:3000/freee/sections?company_id=${FREEE_COMPANY_ID}"

# メモタグマスタ
curl "http://localhost:3000/freee/tags?company_id=${FREEE_COMPANY_ID}"

# 税区分マスタ
curl "http://localhost:3000/freee/taxes?company_id=${FREEE_COMPANY_ID}"
```

### 2.2 分析・集計API

```bash
# 月次推移表
curl "http://localhost:3000/freee/monthly-trends?company_id=${FREEE_COMPANY_ID}&start_date=2025-01-01&end_date=2025-09-30"

# 増減要因分析
curl "http://localhost:3000/freee/variance-analysis?company_id=${FREEE_COMPANY_ID}&current_start=2025-09-01&current_end=2025-09-30&previous_start=2025-08-01&previous_end=2025-08-31"

# 計上ルート別集計
curl "http://localhost:3000/freee/entry-route-analysis?company_id=${FREEE_COMPANY_ID}&start_date=2025-09-01&end_date=2025-09-30"

# 取引先別年間集計
curl "http://localhost:3000/freee/partner-yearly-summary?company_id=${FREEE_COMPANY_ID}&year=2025"
```

### 2.3 予算管理API

```bash
# 予算データ登録
curl -X POST "http://localhost:3000/freee/budgets" \
  -H "Content-Type: application/json" \
  -d '{
    "year": 2025,
    "month": 9,
    "account_item_id": 400,
    "amount": 1000000
  }'

# 予算データ取得
curl "http://localhost:3000/freee/budgets?year=2025&month=9"

# 予実比較
curl "http://localhost:3000/freee/budget-comparison?company_id=${FREEE_COMPANY_ID}&year=2025&month=9"
```

---

## 3. Excelエクスポート機能

全エンドポイントのデータをExcelファイルにエクスポートできます。

```bash
# 全データをExcelにエクスポート
node scripts/export_to_excel.js

# 出力先: output/freee_export_[timestamp].xlsx
```

## 4. トラブルシューティング

### 4.1 トークンが無効な場合

```bash
# トークンを再取得
node scripts/get_token.js
```

### 4.2 レート制限エラー

システムには自動リトライ機能が実装されていますが、頻繁に発生する場合はリクエスト間隔を調整してください。

### 4.3 ログ確認

```bash
# エラーログ確認
tail -f logs/error.log

# 統合ログ確認  
tail -f logs/combined.log
```

## 5. 実装済み機能一覧

### 5.1 認証・セキュリティ
- ✅ OAuth2.0リフレッシュトークン実装
- ✅ AES-256-GCM暗号化によるトークン保存
- ✅ 自動トークン更新機能

### 5.2 エラーハンドリング・信頼性
- ✅ 指数バックオフによるリトライ機構
- ✅ レート制限対応（トークンバケット方式）
- ✅ 構造化JSONログ出力
- ✅ ログローテーション機能

### 5.3 キャッシュ・監査
- ✅ SQLiteベースのキャッシュシステム
- ✅ 包括的な監査ログ機能
- ✅ データ整合性検証（SHA-256ハッシュ）

### 5.4 Excel出力
- ✅ 全エンドポイント対応のExcelエクスポート
- ✅ レポートタイプ別の最適化されたシート構造

## 6. 問い合わせ

本システムに関する質問や不具合報告は、プロジェクトのIssuesへお願いします。
