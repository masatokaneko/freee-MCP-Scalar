# 📄 **会計Freee MCP インターフェース設計書**

最終更新日: 2025-09-21
実装状況: 全API実装完了

## 1. 目的

MCPサーバーが会計Freeeシステムからデータを取得・整形し、
共通フォーマットのJSONとして返却するためのI/F仕様を定義する。

---

## 2. MCP API エンドポイント一覧

| エンドポイント | HTTPメソッド | 説明 | 実装状況 |
| --- | --- | --- | --- |
| `/freee/journals` | GET | 仕訳帳データ取得（detail切り替え対応） | ✅実装済 |
| `/freee/account_items` | GET | 勘定科目マスタ取得 | ✅実装済 |
| `/freee/partners` | GET | 取引先マスタ取得 | ✅実装済 |
| `/freee/items` | GET | 品目マスタ取得 | ✅実装済 |
| `/freee/sections` | GET | 部門マスタ取得 | ✅実装済 |
| `/freee/tags` | GET | メモタグ取得 | ✅実装済 |
| `/freee/taxes` | GET | 税区分取得 | ✅実装済 |
| `/freee/monthly-trends` | GET | 月次推移表作成 | ✅実装済 |
| `/freee/variance-analysis` | GET | 増減要因分析 | ✅実装済 |
| `/freee/entry-route-analysis` | GET | 計上ルート別集計 | ✅実装済 |
| `/freee/partner-yearly-summary` | GET | 取引先別年間集計 | ✅実装済 |
| `/freee/budgets` | POST | 予算データ取込（SQLite永続化） | ✅実装済 |
| `/freee/budgets` | GET | 予算データ取得 | ✅実装済 |
| `/freee/budget-comparison` | GET | 予実比較 | ✅実装済 |

---

## 3. 入力パラメータ仕様（例：仕訳帳）

| パラメータ | 型 | 必須 | 説明 |
| --- | --- | --- | --- |
| `company_id` | number | ○ | Freee会社ID |
| `start_date` | string (YYYY-MM-DD) | ○ | 取得開始日 |
| `end_date` | string (YYYY-MM-DD) | ○ | 取得終了日 |
| `detail` | string | 任意 | 詳細度（simple/standard/full）デフォルト: standard |
| `download_type` | string | ○ | ダウンロード形式（generic固定） |
| `account_item_ids` | array | 任意 | 勘定科目でフィルタ |
| `section_ids` | array | 任意 | 部門でフィルタ |
| `partner_ids` | array | 任意 | 取引先でフィルタ |

---

## 4. 出力仕様（共通スキーマ）

MCPはFreee・QuickBooksの差異を吸収し、統一スキーマで返却する。

### 4.1 journals（仕訳データ）

```jsonc
{
  "journals": [
    {
      "system": "freee",                // データソース
      "transaction_date": "2025-03-10", // 取引日
      "voucher_number": "2025-000123",  // 仕訳番号 or DocNumber
      "entry_line_no": 1,
      "debit_account_code": "500",
      "debit_account_name": "旅費交通費",
      "credit_account_code": "211",
      "credit_account_name": "未払金",
      "amount": 15000,
      "currency": "JPY",
      "currency_rate": 1.0,
      "partner_id": "P-123",
      "partner_name": "東京交通株式会社",
      "item_id": null,
      "item_name": null,
      "section_id": "S-12",
      "section_name": "営業部",
      "tax_code": "課税10%",
      "tax_amount": 1500,
      "register_method": "支払依頼",
      "approval_status": "承認済",
      "created_by": "taro@company.com",
      "created_at": "2025-03-10T10:00:00+09:00"
    }
  ]
}
```

---

### 4.2 account\_items（勘定科目マスタ）

```jsonc
{
  "account_items": [
    {
      "system": "freee",
      "id": "A-400",
      "code": "400",
      "name": "売上高",
      "account_group_display_name": "営業収益",
      "account_item_category": "収益",
      "normal_balance": "credit",
      "active": true,
      "tax_code_id": "01",
      "account_bank_id": null,
      "shortcut1": "売上",
      "shortcut2": "Uriage",
      "created_at": "2023-01-01T10:00:00Z",
      "updated_at": "2025-01-01T10:00:00Z"
    }
  ]
}
```

---

### 4.3 partners / items / sections

```jsonc
{
  "partners": [
    {
      "id": "P-123",
      "code": "CUST-123",
      "name": "取引先A",
      "active": true,
      "created_at": "2024-05-01",
      "updated_at": "2025-01-01"
    }
  ],
  "items": [
    {
      "id": "I-55",
      "code": "ITEM-55",
      "name": "ソフトウェアライセンス",
      "category": "売上品目"
    }
  ],
  "sections": [
    {
      "id": "S-12",
      "code": "BU-SALES",
      "name": "営業部"
    }
  ]
}
```

---

## 5. 実装済み機能詳細

### 5.1 認証・セキュリティ機能
- ✅ OAuth2.0リフレッシュトークン自動更新
- ✅ AES-256-GCM暗号化によるトークン保存
- ✅ トークン有効期限管理と自動更新

### 5.2 信頼性向上機能
- ✅ 指数バックオフによるリトライ機構（全API実装済）
- ✅ トークンバケット方式のレート制限対応
- ✅ エラーハンドリング強化

### 5.3 パフォーマンス最適化
- ✅ SQLiteベースのキャッシュシステム
- ✅ データ整合性検証（SHA-256ハッシュ）
- ✅ ページネーション対応

### 5.4 監査・ログ機能
- ✅ 構造化JSONログ出力
- ✅ ログローテーション機能
- ✅ 包括的な監査ログ記録

### 5.5 データ出力機能
- ✅ 全エンドポイント対応のExcelエクスポート
- ✅ レポートタイプ別の最適化されたシート構造

---

## 6. エラーレスポンス仕様

```jsonc
{
  "error": true,
  "message": "Freee API authentication failed. Please refresh token.",
  "code": "AUTH_ERROR",
  "timestamp": "2025-03-31T10:00:00Z"
}
```

---

## 7. 認証フロー

### OAuth2.0 認証（実装済み）
1. 初期認証: `/scripts/get_token.js`でアクセストークン取得
2. 会社ID取得: `/scripts/get_company.js`で対象会社選択
3. 自動更新: トークン有効期限前に自動リフレッシュ
4. 暗号化保存: AES-256-GCMで安全に保存

---

## 8. ログ仕様

* リクエスト・レスポンスをJSONファイルで保存（監査証跡）
* エラー発生時は再試行回数を記録

---

## 9. パフォーマンス要件（達成済み）

* ✅ 1リクエストで最大10,000件取得
* ✅ ページネーション対応（Freee: `offset` / `limit`）
* ✅ レスポンスタイム: 5秒以内（仕訳1,000件）
* ✅ キャッシュによる高速化実装済み

---

## 10. セキュリティ要件（実装済み）

* ✅ ローカル `.env` に機密情報を保存（Git管理外）
* ✅ HTTPS通信必須
* ✅ 取得データは暗号化ストレージにキャッシュ（SQLite実装済）
* ✅ AES-256-GCM暗号化によるトークン保護
* ✅ 監査ログによるアクセス追跡

---