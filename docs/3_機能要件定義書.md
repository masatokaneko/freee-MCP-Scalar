# **会計Freee MCP 機能要件定義書**

## 1. システム概要

会計freeeのAPIを通じて、仕訳データおよび各種マスタデータ（勘定科目、取引先、品目、部門、税区分、タグ等）を一元取得し、
連結財務諸表作成、月次推移表、予実比較、増減要因分析、計上ルート別分析を自動化する。

---

## 2. 機能一覧

| 機能カテゴリ        | 機能概要        | 詳細要件                                            |
| ------------- | ----------- | ----------------------------------------------- |
| **認証機能**      | OAuth2.0認証  | freee APIとの安全な連携。リフレッシュトークンを安全に管理。              |
| **仕訳データ取得**   | 期間指定仕訳取得    | 仕訳帳の借方／貸方、取引先、部門、品目、税区分、計上ルート、承認ステータスを含むデータを取得。 |
|               | フィルタリング機能   | 期間、勘定科目、部門、取引先などで絞り込み可能。                        |
| **マスタデータ取得**  | 勘定科目マスタ     | 勘定科目名、コード、決算書表示名、カテゴリー、使用設定、税区分、口座IDなどを取得。      |
|               | 部門マスタ       | 部門名、コード、階層構造を取得。                                |
|               | 取引先マスタ      | 取引先名、コード、内部取引識別用フラグを取得。                         |
|               | 品目マスタ       | 品目名、コード、品目カテゴリーを取得。                             |
|               | メモタグマスタ     | メモタグID、タグ名を取得。                                  |
|               | 税区分マスタ      | 課税／非課税、税率、軽減税率フラグを取得。                           |
| **データ整形機能**   | 借方・貸方統一化    | JSONで借方／貸方行を統一フォーマットに変換。                        |
|               | 計上ルート付与     | 仕訳の作成元（自動仕訳、支払依頼、口座振替、経費精算）を判別して付与。             |
|               | 通貨換算        | 多通貨対応時は換算レートを付与し、円建て集計が可能に。                     |
|               | セグメント展開     | セグメント1～3をキーとして保持、管理会計で利用可能。                     |
| **集計機能**      | 月次推移表作成     | 勘定科目別、部門別、取引先別、品目別に月次残高を自動集計。                   |
|               | 増減要因分析      | 前月比・前年比での金額増減を計算、取引先・品目単位で深掘り可能。                |
|               | 計上ルート別集計    | 自動仕訳率、支払依頼比率、手入力比率を可視化。                         |
|               | 予実比較        | 予算データを取り込み、科目・部門・取引先別に実績と比較。                    |
| **出力機能**      | JSON出力      | 統一スキーマのJSONとして返却。                               |
|               | CSV/Excel出力 | 必要に応じてCSV形式でエクスポート可能。                           |
|               | ダッシュボード連携   | GoogleスプレッドシートやBIツールに接続可能。                      |
| **監査ログ機能**    | 操作履歴管理      | 誰がいつどのデータを取得したかログに残す。                           |
| **エラーハンドリング** | APIエラー対応    | freee APIのレート制限、認証エラー、データ欠損をハンドリングし再試行。         |

---

## 3. 入出力仕様

### 3.1 入力パラメータ例

```jsonc
{
  "company_id": 12345,
  "start_date": "2025-01-01",
  "end_date": "2025-03-31",
  "account_item_codes": ["400", "500"],
  "section_ids": [1, 2],
  "partner_ids": [101, 102]
}
```

### 3.2 出力フォーマット例

```jsonc
{
  "journals": [
    {
      "transaction_date": "2025-03-10",
      "account_item_code": "400",
      "account_item_name": "売上高",
      "debit_credit": "credit",
      "amount": 100000,
      "partner_id": 101,
      "partner_name": "取引先A",
      "section_id": 2,
      "section_name": "営業部",
      "item_id": 5,
      "item_name": "サービスX",
      "tax_code": "課税10%",
      "tax_amount": 10000,
      "register_method": "自動仕訳",
      "approval_status": "承認済",
      "created_by": "user@example.com",
      "created_at": "2025-03-10T09:00:00+09:00"
    }
  ],
  "account_items": [
    {
      "id": 101,
      "code": "400",
      "name": "売上高",
      "account_group_display_name": "営業収益",
      "account_item_category": "収益",
      "normal_balance": "credit",
      "active": true,
      "tax_code_id": "01",
      "account_bank_id": null
    }
  ],
  "metadata": {
    "fetched_at": "2025-03-31T23:59:00+09:00",
    "source": "freee",
    "company_id": 12345,
    "period": "2025-01-01〜2025-03-31"
  }
}
```

---

## 4. 非機能要件（簡易版）

* レスポンス時間：仕訳10,000件で5分以内
* データ更新：毎日自動取得、またはユーザー指示で再取得
* セキュリティ：OAuth2.0認証、読み取り専用、操作ログ保存
* 可用性：決算期の高負荷でも動作（再試行機能あり）

---

## 5. 今後の拡張

* QuickBooks, SAP連携
* 仕訳自動登録機能
* 監査法人への自動レポート送信
* 予算シナリオシミュレーション（AI予測）

---

これで機能要件が網羅的になりました。
特にマスタデータ（勘定科目・部門・取引先・品目・税区分・タグ）をすべて取得することを明記したので、開発フェーズでの抜け漏れを防げます。

---
