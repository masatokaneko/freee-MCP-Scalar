# 勘定科目コード体系ガイド

最終更新日: 2025-09-25

このドキュメントでは `account_code_catalog.csv` で出力される勘定科目コードの設計ポリシーと生成ルールを説明します。freee の仕訳データを Google Sheets 等で扱いやすくするために、固定長の階層コードを自動付与しています。

## 1. コード構造

```
AA-BB-CC-DD-EEE
```

| 桁 | 意味 | 桁数 | 備考 |
|----|------|------|------|
| AA | 第1階層（大分類） | 2桁 | `資産 / 負債 / 純資産 / 収益 / 費用 / 振替 / 未分類` の順に付番 |
| BB | 第2階層（中分類） | 2桁 | freee の `categories[?]` などをベースに分類 |
| CC | 第3階層（小分類） | 2桁 | 第2階層配下の詳細分類 |
| DD | 第4階層（決算書表示名） | 2桁 | freee の `account_category` に概ね対応 |
| EEE | 第5階層（勘定科目） | 3桁 | 勘定科目（account item）ごとに連番 |

例: `05-05-03-02-009` は「費用 > 経常損益金額 > 営業損益金額 > 販売管理費 > 旅費交通費」を表します。

## 2. 階層割り当てルール

### 2.1 BS 科目（資産・負債・純資産）

- freee API の `account_items` が返す `categories` 配列（例: `資産 > 流動資産 > 現金・預金`）を利用
- 第1階層で `資産 / 負債 / 純資産` を判定し、その下位を順次割り当て
- `account_category` が「決算書表示名」にあたるため、第4階層に設定
- 先頭カテゴリに `資産 / 負債 / 純資産` が含まれ、PL セグメント（`売上総損益金額` など）が存在しない場合は強制的に BS として扱います（科目名に「売上」「費用」が入っていても PL へは移行しません）

### 2.2 PL 科目（収益・費用）

freee の `categories` では PL 科目も「純資産」配下に含まれるため、以下のルールで「収益」「費用」に再分類します。

1. `categories` 内に以下の PL セグメントが含まれているかを判定
   - `売上総損益金額` / `営業損益金額` / `経常損益金額` / `特別利益` / `特別損失` など
2. 名前や決算書表示名に `売上`, `収益`, `費用`, `原価`, `損失`, `仕入`, `税`, `旅費`, `報酬`, `賞与`…といったキーワードが含まれる場合は強制的に収益/費用に分類
3. **収益** に分類された科目は第2〜3階層を元のカテゴリ名・グループ名から採用（例: `営業外収益`）
4. **費用** も同様に `販売管理費`, `原価` などの分類を割り当て
5. `categories` が文字列（`資産 > 流動資産 > 現金・預金`）で返ってきた場合でも自動で分解し、PL セグメントの検知および階層づけを行います

### 2.3 振替・未分類

- 仕訳調整用や配分用で BS/PL どちらにも属さない科目（例: `損益`, `振替`）は第1階層 `振替` として整理
- 判定できない場合は `未分類`（ただし基本的には発生しないよう rule を整備）

## 3. コード生成ロジック

1. freee API (`GET /account_items`) で全勘定科目を取得
2. 上記ルールで階層情報を抽出し、階層ごとに昇順ソート
3. BS 科目については「流動資産→固定資産→…」といった一般的な財務諸表の並びに合わせて優先順位を適用（流動資産の内部でも「現金・預金→売上債権→棚卸資産→その他流動資産」の順番を固定）
4. 各階層ごとに 00〜99（第1〜4階層）、000〜999（第5階層）で連番を振る
5. freee のショートカットコード `shortcut_num` は `freee_code` として保持
   - `shortcut_num` が空の場合は `ACCT-<freee_id>` を付与（`TEMP-<名称>` が入ることはありません）
6. 最終的に `account_code_catalog.csv` に `hierarchical_code` と `freee_code` をセットで出力

## 4. 取引先・品目・部門月次表への反映

- `scripts/generate_pl_report.js` は上記階層コードを参照し、取引先・品目・部門の月次差額 CSV にも同じ `勘定コード` を付与
- 各内訳と勘定科目の差額が一致するかを自動検証し、差異がある場合は警告を表示

## 5. 対照表（account_code_catalog.csv）の項目

| 列名 | 説明 |
|------|------|
| `hierarchical_code` | 新しい 2-2-2-2-3 桁コード |
| `freee_code` | freee のショートカットコード（例: 700）|
| `freee_id` | freee API の勘定科目 ID |
| `name` | 勘定科目名 |
| `shortcut_num` | freee の `shortcut_num` |
| `level1〜4` | 各階層の名称 |
| `account_category` | 決算書表示名（freee の `account_category`）|
| `group_id`, `group_name`, `update_date` | freee API が返す付帯情報 |

## 6. 利用時の注意

- コード生成は勘定科目マスタを再取得するたびに安定して再現できるように設計しています（既存科目の名前が変わらない限りコードは変わりません）。
- 科目が追加された場合は、空いている連番を自動的に採番します。
- 分類ルールを変更したい場合は `scripts/generate_pl_report.js` 内の `deriveLevels` およびキーワード定義を調整してください。

---

参照: `README.md` 「CSVへのエクスポート」、`scripts/export_freee_reports.js`（レポート出力の CLI）、`account_code_catalog.csv`。
